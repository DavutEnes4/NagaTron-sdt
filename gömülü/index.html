<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Robot Kontrol Paneli</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root{ --bg:#f5f5f5; --card:#fff; --ink:#111; --muted:#666; --shadow:#0002; --ok:#2e7d32; --bad:#c62828; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--ink); padding: 24px; }
    h1 { margin: 0 0 16px; }
    h2 { margin: 0 0 10px; font-size: 18px; }
    .row { display: flex; flex-wrap: wrap; gap: 16px; }
    .section { flex: 1 1 380px; background: var(--card); border-radius: 10px; padding: 16px; box-shadow: 0 6px 16px var(--shadow); }
    input, select, button { padding: 8px 10px; margin: 6px 6px 6px 0; font-size: 14px; }
    button { cursor: pointer; border: 0; border-radius: 8px; background: #1976d2; color: #fff; }
    button.secondary { background: #616161; }
    button.warn { background: #ef6c00; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    label { color: var(--muted); font-size: 13px; display: inline-block; margin-right: 8px; }
    #logArea { background: #000; color: #b7ffb7; padding: 10px; height: 240px; overflow-y: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; border-radius: 8px; }
    .status { font-size: 14px; margin-left: 8px; }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; background: #bbb; }
    .dot.ok { background: var(--ok); }
    .dot.bad { background: var(--bad); }
  </style>
</head>
<body>

  <h1>ðŸ“¡ Robot Kontrol Paneli
    <span class="status"><span id="connDot" class="dot"></span><span id="connText">BaÄŸlantÄ± yok</span></span>
  </h1>

  <div class="row">

    <div class="section">
      <h2>Broker</h2>
      <label for="broker">WebSocket MQTT URL</label>
      <input id="broker" size="34" value="ws://nagatron-sdt.local:9001" />
      <button id="btnConnect" onclick="connectMQTT()">BaÄŸlan</button>
      <button class="secondary" onclick="disconnectMQTT()">Kes</button>
    </div>

    <div class="section">
      <h2>Mod SeÃ§imi</h2>
      <select id="modeSelect">
        <option value="LINE">Ã‡izgi Takip (LINE)</option>
        <option value="MANUAL">Manuel (MANUAL)</option>
      </select>
      <button onclick="setMode()">MOD GÃ–NDER</button>
    </div>

    <div class="section">
      <h2>Temel Komutlar</h2>
      <button onclick="sendCommand('START')">START</button>
      <button onclick="sendCommand('STOP')" class="warn">STOP</button>
      <button onclick="sendCommand('RESTART')">RESTART</button>
    </div>

    <div class="section">
      <h2>HÄ±z ve PID AyarÄ±</h2>
      <div>
        <label>HÄ±z:</label>
        <input type="number" id="speedInput" value="75" min="0" max="255" />
        <button onclick="sendSpeed()">HIZ GÃ–NDER</button>
      </div>
      <div>
        <label>Kp:</label><input type="number" id="kp" value="0.8" step="0.1" />
        <label>Ki:</label><input type="number" id="ki" value="0.0" step="0.01" />
        <label>Kd:</label><input type="number" id="kd" value="2.0" step="0.1" />
        <button onclick="sendPID()">PID GÃ–NDER</button>
      </div>
    </div>

    <div class="section">
      <h2>Manuel Komut</h2>
      <div>
        <label>MOVE (R,L):</label>
        <input id="moveInput" placeholder="Ã¶rn: 1,-1" />
        <button onclick="sendMove()">MOVE</button>
        <button class="secondary" onclick="publishCmd('MOVE:1,1')">Ä°leri (1,1)</button>
        <button class="secondary" onclick="publishCmd('MOVE:-1,-1')">Geri (-1,-1)</button>
        <button class="secondary" onclick="publishCmd('MOVE:0,0')">Dur (0,0)</button>
      </div>
      <div>
        <label>ANGLE (Â°):</label>
        <input id="angleInput" placeholder="Ã¶rn: 90" />
        <button onclick="sendAngle()">ANGLE</button>
      </div>
    </div>

    <div class="section">
      <h2>Delay DÃ¶nme</h2>
      <button onclick="sendCommand('TURNRIGHT')">LEFT 90Â°</button>
      <button onclick="sendCommand('TURNLEFT')">RIGHT 90Â°</button>
    </div>

    <div class="section">
      <h2>Teker YÃ¶nÃ¼ (DIR)</h2>
      <label>SaÄŸ:</label>
      <select id="dirR">
        <option value="1">Normal (+1)</option>
        <option value="-1">Ters (-1)</option>
      </select>
      <label>Sol:</label>
      <select id="dirL">
        <option value="1">Normal (+1)</option>
        <option value="-1">Ters (-1)</option>
      </select>
      <button onclick="sendDir()">YÃ–N GÃ–NDER</button>
    </div>

    <div class="section" style="flex-basis:100%">
      <h2>ðŸ“¥ Geri Bildirim (robot/log)</h2>
      <div id="logArea">BaÄŸlantÄ± bekleniyor...</div>
      <div style="margin-top:8px;">
        <button class="secondary" onclick="clearLog()">Logu Temizle</button>
      </div>
    </div>

  </div>

<script>
  // ==== Ayarlar ====
  const commandTopic = 'robot/command';
  const logTopic = 'robot/log';
  let client = null;
  let connected = false;

  // ==== BaÄŸlantÄ± YardÄ±mcÄ±larÄ± ====
  function setConnected(state, note='') {
    connected = state;
    const dot = document.getElementById('connDot');
    const txt = document.getElementById('connText');
    dot.className = 'dot' + (state ? ' ok' : ' bad');
    txt.textContent = state ? ('BaÄŸlÄ± ' + note) : 'BaÄŸlantÄ± yok';
    document.querySelectorAll('button').forEach(b=>{
      if (b.id === 'btnConnect') return; // baÄŸlan butonu hep aktif
      b.disabled = !state;
    });
  }

  function connectMQTT() {
    const url = document.getElementById('broker').value.trim();
    if (!url) { logPrint('Broker URL boÅŸ olamaz'); return; }

    if (client) { try { client.end(true); } catch(e){} }
    logPrint('MQTT baÄŸlanÄ±lÄ±yor: ' + url + ' ...');

    try {
      client = mqtt.connect(url, { reconnectPeriod: 2000 });
    } catch (e) {
      logPrint('MQTT connect() hatasÄ±: ' + e);
      return;
    }

    client.on('connect', () => {
      setConnected(true);
      logPrint('MQTT baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!');
      client.subscribe(logTopic, (err)=>{
        if (err) logPrint('Subscribe hata: ' + err);
        else logPrint('Subscribed: ' + logTopic);
      });
    });

    client.on('reconnect', () => {
      setConnected(false, '(yeniden baÄŸlanÄ±lÄ±yor)');
      logPrint('MQTT reconnect...');
    });

    client.on('offline', () => {
      setConnected(false, '(offline)');
      logPrint('MQTT offline');
    });

    client.on('error', (err) => {
      setConnected(false, '(hata)');
      logPrint('MQTT error: ' + err);
    });

    client.on('close', () => {
      setConnected(false, '(kapandÄ±)');
      logPrint('MQTT connection closed');
    });

    client.on('message', (topic, payload) => {
      if (topic === logTopic) {
        logPrint('LOG: ' + payload.toString());
      }
    });
  }

  function disconnectMQTT() {
    if (client) {
      logPrint('MQTT baÄŸlantÄ±sÄ± kesiliyor...');
      try { client.end(true); } catch(e){}
      client = null;
    }
    setConnected(false);
  }

  // ==== Komut gÃ¶ndericiler ====
  function publishCmd(cmd) {
    if (!connected || !client) { logPrint('BaÄŸlÄ± deÄŸilken komut gÃ¶nderilemez'); return; }
    const msgObj = { cmd: cmd };
    const payload = JSON.stringify(msgObj);
    client.publish(commandTopic, payload);
    logPrint('GÃ–NDERÄ°LDÄ°: ' + payload);
  }

  function sendCommand(cmd) { publishCmd(cmd); }

  function setMode() {
    const mode = document.getElementById('modeSelect').value;
    publishCmd('MODE:' + mode);
  }

  function sendSpeed() {
    const v = parseInt(document.getElementById('speedInput').value, 10);
    if (Number.isNaN(v)) { logPrint('HÄ±z sayÄ±sal olmalÄ±'); return; }
    const spd = Math.max(0, Math.min(255, v));
    publishCmd('SPD:' + spd);
  }

  function sendPID() {
    const kp = parseFloat(document.getElementById('kp').value);
    const ki = parseFloat(document.getElementById('ki').value);
    const kd = parseFloat(document.getElementById('kd').value);
    if ([kp,ki,kd].some(x=>Number.isNaN(x))) {
      logPrint('PID deÄŸerleri sayÄ±sal olmalÄ±');
      return;
    }
    publishCmd('PID:' + kp + ',' + ki + ',' + kd);
  }

  function sendMove() {
    const raw = (document.getElementById('moveInput').value || '').trim();
    if (!raw) { logPrint('MOVE boÅŸ olamaz (Ã¶rn: 1,-1)'); return; }
    const m = raw.split(',');
    if (m.length !== 2) { logPrint('MOVE formatÄ± hatalÄ±. Ã–rn: 1,-1'); return; }
    const r = parseInt(m[0],10), l = parseInt(m[1],10);
    if ([r,l].some(x => Number.isNaN(x) || x < -1 || x > 1)) {
      logPrint('MOVE sadece -1,0,1 kabul eder'); return;
    }
    publishCmd('MOVE:' + r + ',' + l);
  }

  function sendAngle() {
    const raw = (document.getElementById('angleInput').value || '').trim();
    const ang = parseInt(raw, 10);
    if (Number.isNaN(ang)) { logPrint('ANGLE sayÄ±sal olmalÄ± (Ã¶rn: 90)'); return; }
    publishCmd('ANGLE:' + ang);
  }

  function sendDir() {
    const dr = parseInt(document.getElementById('dirR').value, 10);
    const dl = parseInt(document.getElementById('dirL').value, 10);
    publishCmd('DIR:' + dr + ',' + dl);   // Ã¶r: DIR:1,-1
  }

  // ==== Log yardÄ±mcÄ±larÄ± ====
  function logPrint(msg) {
    const area = document.getElementById('logArea');
    const timestamp = new Date().toLocaleTimeString();
    area.innerHTML += `[${timestamp}] ${msg}<br>`;
    area.scrollTop = area.scrollHeight;
  }
  function clearLog() {
    document.getElementById('logArea').innerHTML = '';
  }

  // Sayfa aÃ§Ä±lÄ±nca otomatik baÄŸlan (istersen yoruma al)
  window.addEventListener('load', () => { connectMQTT(); });
</script>
</body>
</html>
